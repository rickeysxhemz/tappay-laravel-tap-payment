name: Update Changelog

on:
  release:
    types: [released]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to add to changelog (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release info
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            // Support both release event and manual workflow_dispatch
            if (context.eventName === 'workflow_dispatch') {
              const tag = '${{ inputs.tag }}';
              // Fetch release by tag
              try {
                const { data: release } = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tag
                });
                return {
                  tag: release.tag_name,
                  name: release.name || release.tag_name,
                  body: release.body || '',
                  date: release.published_at.split('T')[0],
                  url: release.html_url
                };
              } catch (e) {
                core.setFailed(`Release with tag "${tag}" not found`);
                return null;
              }
            }

            const release = context.payload.release;
            return {
              tag: release.tag_name,
              name: release.name || release.tag_name,
              body: release.body || '',
              date: release.published_at.split('T')[0],
              url: release.html_url
            };
          result-encoding: json

      - name: Update CHANGELOG.md
        if: steps.release.outputs.result != 'null'
        uses: actions/github-script@v7
        env:
          RELEASE_DATA: ${{ steps.release.outputs.result }}
        with:
          script: |
            const fs = require('fs');
            const release = JSON.parse(process.env.RELEASE_DATA);

            const changelogPath = 'CHANGELOG.md';
            let changelog = '';

            // Read existing changelog or create header
            if (fs.existsSync(changelogPath)) {
              changelog = fs.readFileSync(changelogPath, 'utf8');
            } else {
              changelog = '# Changelog\n\nAll notable changes to this project will be documented in this file.\n\nThe format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),\nand this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).\n\n';
            }

            // Check if this version already exists (prevent duplicates)
            if (changelog.includes(`## [${release.tag}]`)) {
              console.log(`Version ${release.tag} already exists in changelog, skipping`);
              return;
            }

            // Format release body (handle empty body)
            let releaseBody = release.body || 'No release notes provided.';

            // Convert GitHub PR/issue references to links (avoid matching URL anchors like url#123)
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            releaseBody = releaseBody.replace(/(?<![/\w=])#(\d+)\b/g, `[#$1](${repoUrl}/issues/$1)`);

            // Create new entry
            const newEntry = `## [${release.tag}](${release.url}) - ${release.date}\n\n${releaseBody}\n\n`;

            // Find position to insert (after header, before first version)
            const headerEnd = changelog.indexOf('\n## ');
            if (headerEnd === -1) {
              // No existing versions, append to end
              changelog = changelog + newEntry;
            } else {
              // Insert after header
              changelog = changelog.slice(0, headerEnd + 1) + newEntry + changelog.slice(headerEnd + 1);
            }

            fs.writeFileSync(changelogPath, changelog);

      - name: Commit and push changes
        if: steps.release.outputs.result != 'null'
        env:
          RELEASE_DATA: ${{ steps.release.outputs.result }}
        run: |
          # Extract tag from JSON
          RELEASE_TAG=$(echo "$RELEASE_DATA" | jq -r '.tag')

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md

          # Only commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: update CHANGELOG for ${RELEASE_TAG}"

            # Push with retry logic
            for i in 1 2 3; do
              if git push; then
                echo "Push successful"
                exit 0
              fi
              echo "Push failed, attempt $i of 3. Retrying in 5 seconds..."
              sleep 5
              git pull --rebase
            done
            echo "Push failed after 3 attempts"
            exit 1
          fi