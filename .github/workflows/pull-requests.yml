name: Pull Requests

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  # Welcome first-time contributors
  welcome:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Check if first-time contributor
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const prCount = pullRequests.filter(pr => pr.user.login === creator).length;
            return prCount === 1;
          result-encoding: string

      - name: Welcome first-time contributor
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ‘‹ Welcome @' + context.payload.pull_request.user.login + '!\n\nThank you for your first contribution to this project! A maintainer will review your PR soon.\n\nPlease ensure:\n- [ ] Tests pass (`composer test`)\n- [ ] Code follows PSR-12 style\n- [ ] Documentation is updated if needed\n\nWe appreciate your contribution! ðŸŽ‰'
            })

  # Auto-label PRs based on files changed
  auto-label:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    steps:
      - name: Get changed files
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return files.map(f => f.filename);
          result-encoding: json

      - name: Add labels based on files
        uses: actions/github-script@v7
        with:
          script: |
            const files = ${{ steps.files.outputs.result }};
            const labels = [];

            // Check for documentation changes
            if (files.some(f => f.endsWith('.md') || f.startsWith('docs/'))) {
              labels.push('documentation');
            }

            // Check for test changes
            if (files.some(f => f.startsWith('tests/') || f.includes('Test.php'))) {
              labels.push('tests');
            }

            // Check for source code changes
            if (files.some(f => f.startsWith('src/'))) {
              labels.push('source');
            }

            // Check for config changes
            if (files.some(f => f.startsWith('config/') || f === 'phpunit.xml' || f === '.php-cs-fixer.php' || f === 'phpstan.neon.dist')) {
              labels.push('config');
            }

            // Check for workflow changes
            if (files.some(f => f.startsWith('.github/'))) {
              labels.push('ci');
            }

            // Check for dependency changes
            if (files.some(f => f === 'composer.json' || f === 'composer.lock')) {
              labels.push('dependencies');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }

  # Size labeling
  size-label:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let sizeLabel;
            if (total < 10) {
              sizeLabel = 'size/XS';
            } else if (total < 50) {
              sizeLabel = 'size/S';
            } else if (total < 200) {
              sizeLabel = 'size/M';
            } else if (total < 500) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }

            // Remove existing size labels
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const label of labels) {
              if (label.name.startsWith('size/')) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label.name
                  });
                } catch (e) {
                  // Label already removed or doesn't exist, continue
                }
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [sizeLabel]
            });

  # Check PR title follows conventional commits (only on open, not every sync)
  conventional-title:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Check PR title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const conventionalPattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+/;

            if (!conventionalPattern.test(title)) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âš ï¸ **PR Title Check**\n\nYour PR title doesn\'t follow the [Conventional Commits](https://www.conventionalcommits.org/) format.\n\nExpected format: `type(scope): description`\n\nExamples:\n- `feat: add new payment method`\n- `fix(webhook): handle empty payload`\n- `docs: update installation guide`\n\nValid types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`'
              });
            }